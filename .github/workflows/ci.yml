name: CI

on:
    pull_request:
        paths:
            - "portal/**"
            - "api/**"
            - ".github/workflows/portal-ci.yml"

permissions:
    contents: read

jobs:
    validate-portal:
        name: Validate changes
        runs-on: ubuntu-latest

        steps:
            - name: Checkout code
              uses: actions/checkout@v4
              with:
                  fetch-depth: 0
                  filter: tree:0

            - name: Setup Node
              uses: actions/setup-node@v6
              with:
                  node-version: "22"
                  cache: "npm"

            - name: Setup .NET
              uses: actions/setup-dotnet@v5
              with:
                  dotnet-version: 10.0.x

            - name: Cache Playwright browsers
              uses: actions/cache@v5
              id: playwright-cache
              with:
                  path: ~/.cache/ms-playwright
                  key: ${{ runner.os }}-playwright-${{ hashFiles('portal/bun.lock') }}
                  restore-keys: |
                      ${{ runner.os }}-playwright-

            - name: Install Playwright browsers
              if: steps.playwright-cache.outputs.cache-hit != 'true'
              run: npx playwright install chromium --with-deps

            - name: Cache NuGet packages
              uses: actions/cache@v5
              with:
                  path: ~/.nuget/packages
                  key: ${{ runner.os }}-nuget-${{ hashFiles('api/**/*.csproj') }}
                  restore-keys: |
                      ${{ runner.os }}-nuget-

            - name: Install build dependencies
              run: npm ci --include=optional

            - name: Build changes
              run: npx nx affected -t restore lint test build --base=origin/main --head=$PR_BRANCH_NAME
              env:
                  BETTER_AUTH_SECRET: ${{ secrets.BETTER_AUTH_SECRET }}
